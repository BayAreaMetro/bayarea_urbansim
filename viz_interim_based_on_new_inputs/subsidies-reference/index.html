
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="http://bayareametro.github.io/bayarea_urbansim/viz_interim_based_on_new_inputs/subsidies-reference/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>subsidies - Bay Area UrbanSim</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#subsidies-module" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Bay Area UrbanSim" class="md-header__button md-logo" aria-label="Bay Area UrbanSim" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bay Area UrbanSim
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              subsidies
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/BayAreaMetro/bayarea_urbansim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../model_overview/" class="md-tabs__link">
      Model Overview
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../user_guide/" class="md-tabs__link">
      User Guide
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../input/" class="md-tabs__link">
      Input
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../output/" class="md-tabs__link">
      Output
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../pba50/" class="md-tabs__link">
      PBA50
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../models-reference/" class="md-tabs__link md-tabs__link--active">
        Code Reference
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Bay Area UrbanSim" class="md-nav__button md-logo" aria-label="Bay Area UrbanSim" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Bay Area UrbanSim
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/BayAreaMetro/bayarea_urbansim" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../model_overview/" class="md-nav__link">
        Model Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../user_guide/" class="md-nav__link">
        User Guide
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../input/" class="md-nav__link">
        Input
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../output/" class="md-nav__link">
        Output
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../pba50/" class="md-nav__link">
        PBA50
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          Code Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code Reference" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Code Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../models-reference/" class="md-nav__link">
        models
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          subsidies
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        subsidies
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#baus.subsidies" class="md-nav__link">
    subsidies
  </a>
  
    <nav class="md-nav" aria-label="subsidies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer" class="md-nav__link">
    run_subsidized_developer()
  </a>
  
    <nav class="md-nav" aria-label="run_subsidized_developer()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#baus.subsidies" class="md-nav__link">
    subsidies
  </a>
  
    <nav class="md-nav" aria-label="subsidies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer" class="md-nav__link">
    run_subsidized_developer()
  </a>
  
    <nav class="md-nav" aria-label="run_subsidized_developer()">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer--parameters" class="md-nav__link">
    Parameters
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#baus.subsidies.run_subsidized_developer--returns" class="md-nav__link">
    Returns
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  <a href="https://github.com/BayAreaMetro/bayarea_urbansim/edit/master/docs/subsidies-reference.md" title="Edit this page" class="md-content__button md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>


<h1 id="subsidies-module">Subsidies module</h1>


<div class="doc doc-object doc-module">



<h2 id="baus.subsidies" class="doc doc-heading">
          <code>baus.subsidies</code>


</h2>

  <div class="doc doc-contents first">

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h3 id="baus.subsidies.run_subsidized_developer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run_subsidized_developer</span><span class="p">(</span><span class="n">feasibility</span><span class="p">,</span> <span class="n">parcels</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">acct_settings</span><span class="p">,</span> <span class="n">developer_settings</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">form_to_btype_func</span><span class="p">,</span> <span class="n">add_extra_columns_func</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">create_deed_restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="s1">&#39;Unnamed&#39;</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>The subsidized residential developer model.</p>
<h5 id="baus.subsidies.run_subsidized_developer--parameters">Parameters</h5>

<details class="feasibility-">
  <summary>DataFrame</summary>
  <p>A DataFrame that is returned from run_feasibility for a given form</p>
</details>
<details class="parcels-">
  <summary>DataFrameWrapper</summary>
  <p>The standard parcels DataFrameWrapper (mostly just for run_developer)</p>
</details>
<details class="buildings-">
  <summary>DataFrameWrapper</summary>
  <p>The standard buildings DataFrameWrapper (passed to run_developer)</p>
</details>
<details class="households-">
  <summary>DataFrameWrapper</summary>
  <p>The households DataFrameWrapper (passed to run_developer)</p>
</details>
<details class="acct_settings-">
  <summary>Dict</summary>
  <p>A dictionary of settings to parameterize the model.  Needs these keys: sending_buildings_subaccount_def - maps buildings to subaccounts
receiving_buildings_filter - filter for eligible buildings</p>
</details>
<details class="settings-">
  <summary>Dict</summary>
  <p>The overall settings</p>
</details>
<details class="account-">
  <summary>Account</summary>
  <p>The Account object to use for subsidization</p>
</details>
<details class="year-">
  <summary>int</summary>
  <p>The current simulation year (will be added as metadata)</p>
</details>
<details class="form_to_btype_func-">
  <summary>function</summary>
  <p>Passed through to run_developer</p>
</details>
<details class="add_extra_columns_func-">
  <summary>function</summary>
  <p>Passed through to run_developer</p>
</details>
<details class="summary-">
  <summary>Summary</summary>
  <p>Used to add parcel summary information</p>
</details>
<details class="create_deed_restricted-">
  <summary>bool</summary>
  <p>Bool for whether to create deed restricted units with the subsidies or not.  The logic at the time of this writing is to keep track of
partial units so that when partial units sum to greater than a unit, that unit will be deed restricted.</p>
</details>      <h5 id="baus.subsidies.run_subsidized_developer--returns">Returns</h5>
<p>Nothing</p>
<p>Subsidized residential developer is designed to run before the normal residential developer - it will prioritize the developments we're
subsidizing (although this is not strictly required - running this model after the market rate developer will just create a temporarily larger
supply of units, which will probably create less market rate development in the next simulated year). The steps for subsidizing are 
essentially these:</p>
<p>1 run feasibility with only_built set to false so that the feasibility of unprofitable units are recorded
2 temporarily filter to ONLY unprofitable units to check for possible subsidized units (normal developer takes care of market-rate units)
3 compute the number of units in these developments
4 divide cost by number of units in order to get the subsidy per unit
5 filter developments to parcels in "receiving zone" similar to the way we identified "sending zones"
6 iterate through subaccounts one at a time as subsidy will be limited to available funds in the subaccount (usually by jurisdiction)
7 sort ascending by subsidy per unit so that we minimize subsidy (but total subsidy is equivalent to total building cost)
8 cumsum the total subsidy in the buildings and locate the development
    where the subsidy is less than or equal to the amount in the account - filter to only those buildings (these will likely be built)
9 pass the results as "feasible" to run_developer - this is sort of a boundary case of developer but should run OK
10 for those developments that get built, make sure to subtract from account and keep a record (on the off chance that demand is less than
    the subsidized units, run through the standard code path, although it's very unlikely that there would be more subsidized housing than 
    demand)</p>

      <details class="quote">
        <summary>Source code in <code>baus\subsidies.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_subsidized_developer</span><span class="p">(</span><span class="n">feasibility</span><span class="p">,</span> <span class="n">parcels</span><span class="p">,</span> <span class="n">buildings</span><span class="p">,</span> <span class="n">households</span><span class="p">,</span> <span class="n">acct_settings</span><span class="p">,</span> <span class="n">developer_settings</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">form_to_btype_func</span><span class="p">,</span> 
                             <span class="n">add_extra_columns_func</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">create_deed_restricted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="s2">&quot;Unnamed&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The subsidized residential developer model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    feasibility : DataFrame</span>
<span class="sd">        A DataFrame that is returned from run_feasibility for a given form</span>
<span class="sd">    parcels : DataFrameWrapper</span>
<span class="sd">        The standard parcels DataFrameWrapper (mostly just for run_developer)</span>
<span class="sd">    buildings : DataFrameWrapper</span>
<span class="sd">        The standard buildings DataFrameWrapper (passed to run_developer)</span>
<span class="sd">    households : DataFrameWrapper</span>
<span class="sd">        The households DataFrameWrapper (passed to run_developer)</span>
<span class="sd">    acct_settings : Dict</span>
<span class="sd">        A dictionary of settings to parameterize the model.  Needs these keys: sending_buildings_subaccount_def - maps buildings to subaccounts</span>
<span class="sd">        receiving_buildings_filter - filter for eligible buildings</span>
<span class="sd">    settings : Dict</span>
<span class="sd">        The overall settings</span>
<span class="sd">    account : Account</span>
<span class="sd">        The Account object to use for subsidization</span>
<span class="sd">    year : int</span>
<span class="sd">        The current simulation year (will be added as metadata)</span>
<span class="sd">    form_to_btype_func : function</span>
<span class="sd">        Passed through to run_developer</span>
<span class="sd">    add_extra_columns_func : function</span>
<span class="sd">        Passed through to run_developer</span>
<span class="sd">    summary : Summary</span>
<span class="sd">        Used to add parcel summary information</span>
<span class="sd">    create_deed_restricted : bool</span>
<span class="sd">        Bool for whether to create deed restricted units with the subsidies or not.  The logic at the time of this writing is to keep track of</span>
<span class="sd">        partial units so that when partial units sum to greater than a unit, that unit will be deed restricted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing</span>

<span class="sd">    Subsidized residential developer is designed to run before the normal residential developer - it will prioritize the developments we&#39;re</span>
<span class="sd">    subsidizing (although this is not strictly required - running this model after the market rate developer will just create a temporarily larger</span>
<span class="sd">    supply of units, which will probably create less market rate development in the next simulated year). The steps for subsidizing are </span>
<span class="sd">    essentially these:</span>

<span class="sd">    1 run feasibility with only_built set to false so that the feasibility of unprofitable units are recorded</span>
<span class="sd">    2 temporarily filter to ONLY unprofitable units to check for possible subsidized units (normal developer takes care of market-rate units)</span>
<span class="sd">    3 compute the number of units in these developments</span>
<span class="sd">    4 divide cost by number of units in order to get the subsidy per unit</span>
<span class="sd">    5 filter developments to parcels in &quot;receiving zone&quot; similar to the way we identified &quot;sending zones&quot;</span>
<span class="sd">    6 iterate through subaccounts one at a time as subsidy will be limited to available funds in the subaccount (usually by jurisdiction)</span>
<span class="sd">    7 sort ascending by subsidy per unit so that we minimize subsidy (but total subsidy is equivalent to total building cost)</span>
<span class="sd">    8 cumsum the total subsidy in the buildings and locate the development</span>
<span class="sd">        where the subsidy is less than or equal to the amount in the account - filter to only those buildings (these will likely be built)</span>
<span class="sd">    9 pass the results as &quot;feasible&quot; to run_developer - this is sort of a boundary case of developer but should run OK</span>
<span class="sd">    10 for those developments that get built, make sure to subtract from account and keep a record (on the off chance that demand is less than</span>
<span class="sd">        the subsidized units, run through the standard code path, although it&#39;s very unlikely that there would be more subsidized housing than </span>
<span class="sd">        demand)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># step 2</span>
    <span class="n">feasibility</span> <span class="o">=</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">feasibility</span> <span class="o">=</span> <span class="n">feasibility</span><span class="p">[</span><span class="n">feasibility</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="c1"># step 3</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;ave_sqft_per_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parcels</span><span class="o">.</span><span class="n">ave_sqft_per_unit</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;residential_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">feasibility</span><span class="o">.</span><span class="n">residential_sqft</span> <span class="o">/</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">ave_sqft_per_unit</span><span class="p">)</span>

    <span class="c1"># step 3B</span>
    <span class="c1"># can only add units - don&#39;t subtract units - this is an approximation</span>
    <span class="c1"># of the calculation that will be used to do this in the developer model</span>
    <span class="n">feasibility</span> <span class="o">=</span> <span class="n">feasibility</span><span class="p">[</span><span class="n">feasibility</span><span class="o">.</span><span class="n">residential_units</span> <span class="o">&gt;</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">total_residential_units</span><span class="p">]</span>

    <span class="c1"># step 3C</span>
    <span class="c1"># towards the end, because we&#39;re about to sort by subsidy per unit, some</span>
    <span class="c1"># large projects never get built, because it could be a 100 unit project</span>
    <span class="c1"># times a 500k subsidy per unit.  thus we&#39;re going to try filtering by</span>
    <span class="c1"># the maximum subsidy for a single development here</span>
    <span class="n">feasibility</span> <span class="o">=</span> <span class="n">feasibility</span><span class="p">[</span><span class="n">feasibility</span><span class="o">.</span><span class="n">max_profit</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">50</span><span class="o">*</span><span class="mi">1000000</span><span class="p">]</span>

    <span class="c1"># step 4</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;subsidy_per_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;max_profit&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;residential_units&#39;</span><span class="p">]</span>
    <span class="c1"># assumption that even if the developer says this property is almost</span>
    <span class="c1"># profitable, even the administration costs are likely to cost at least</span>
    <span class="c1"># 10k / unit</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s1">&#39;subsidy_per_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">subsidy_per_unit</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

    <span class="c1"># step 5</span>
    <span class="k">if</span> <span class="s2">&quot;receiving_buildings_filter&quot;</span> <span class="ow">in</span> <span class="n">acct_settings</span><span class="p">:</span>
        <span class="n">feasibility</span> <span class="o">=</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">acct_settings</span><span class="p">[</span><span class="s2">&quot;receiving_buildings_filter&quot;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise all buildings are valid</span>
        <span class="k">pass</span>

    <span class="n">new_buildings_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sending_bldgs</span> <span class="o">=</span> <span class="n">acct_settings</span><span class="p">[</span><span class="s2">&quot;sending_buildings_subaccount_def&quot;</span><span class="p">]</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s2">&quot;regional&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">feasibility</span><span class="p">[</span><span class="s2">&quot;subaccount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feasibility</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">sending_bldgs</span><span class="p">)</span>
    <span class="c1"># step 6</span>
    <span class="k">for</span> <span class="n">subacct</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="n">account</span><span class="o">.</span><span class="n">iter_subaccounts</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Subaccount: &quot;</span><span class="p">,</span> <span class="n">subacct</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">feasibility</span><span class="p">[</span><span class="n">feasibility</span><span class="o">.</span><span class="n">subaccount</span> <span class="o">==</span> <span class="n">subacct</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of feasible projects in receiving zone:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># step 7</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;subsidy_per_unit&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># df.to_csv(&#39;subsidized_units_%d_%s_%s.csv&#39; % (orca.get_injectable(&quot;year&quot;), account.name, subacct))</span>

        <span class="c1"># step 8</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amount in subaccount: $</span><span class="si">{:,.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>
        <span class="n">num_bldgs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">df</span><span class="o">.</span><span class="n">max_profit</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">amount</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">num_bldgs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># technically we only build these buildings if there&#39;s demand</span>
        <span class="c1"># print &quot;Building {:d} subsidized buildings&quot;.format(num_bldgs)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">num_bldgs</span><span class="p">)]</span>

        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span>
            <span class="p">[(</span><span class="s2">&quot;residential&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
        <span class="c1"># disable stdout since developer is a bit verbose for this use case</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">old_stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(),</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">developer_settings</span><span class="p">[</span><span class="s1">&#39;residential_developer&#39;</span><span class="p">]</span>
        <span class="c1"># step 9</span>
        <span class="n">new_buildings</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">run_developer</span><span class="p">(</span>
            <span class="s2">&quot;residential&quot;</span><span class="p">,</span>
            <span class="n">households</span><span class="p">,</span>
            <span class="n">buildings</span><span class="p">,</span>
            <span class="s2">&quot;residential_units&quot;</span><span class="p">,</span>
            <span class="n">parcels</span><span class="o">.</span><span class="n">parcel_size</span><span class="p">,</span>
            <span class="n">parcels</span><span class="o">.</span><span class="n">ave_sqft_per_unit</span><span class="p">,</span>
            <span class="n">parcels</span><span class="o">.</span><span class="n">total_residential_units</span><span class="p">,</span>
            <span class="n">orca</span><span class="o">.</span><span class="n">DataFrameWrapper</span><span class="p">(</span><span class="s2">&quot;feasibility&quot;</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span>
            <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
            <span class="n">form_to_btype_callback</span><span class="o">=</span><span class="n">form_to_btype_func</span><span class="p">,</span>
            <span class="n">add_more_columns_callback</span><span class="o">=</span><span class="n">add_extra_columns_func</span><span class="p">,</span>
            <span class="n">profit_to_prob_func</span><span class="o">=</span><span class="n">profit_to_prob_func</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old_stdout</span>
        <span class="n">buildings</span> <span class="o">=</span> <span class="n">orca</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="s2">&quot;buildings&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_buildings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># keep track of partial subsidized untis so that we always get credit</span>
        <span class="c1"># for a partial unit, even if it&#39;s not built in this specific building</span>
        <span class="n">partial_subsidized_units</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># step 10</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">new_building</span> <span class="ow">in</span> <span class="n">new_buildings</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">amt</span> <span class="o">=</span> <span class="n">new_building</span><span class="o">.</span><span class="n">max_profit</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Developing subsidized building&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                <span class="s2">&quot;residential_units&quot;</span><span class="p">:</span> <span class="n">new_building</span><span class="o">.</span><span class="n">residential_units</span><span class="p">,</span>
                <span class="s2">&quot;inclusionary_units&quot;</span><span class="p">:</span> <span class="n">new_building</span><span class="o">.</span><span class="n">inclusionary_units</span><span class="p">,</span>
                <span class="s2">&quot;building_id&quot;</span><span class="p">:</span> <span class="n">index</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">create_deed_restricted</span><span class="p">:</span>

                <span class="n">revenue_per_unit</span> <span class="o">=</span> <span class="n">new_building</span><span class="o">.</span><span class="n">building_revenue</span> <span class="o">/</span> <span class="n">new_building</span><span class="o">.</span><span class="n">residential_units</span>
                <span class="n">total_subsidy</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">new_building</span><span class="o">.</span><span class="n">max_profit</span><span class="p">)</span>
                <span class="n">subsidized_units</span> <span class="o">=</span> <span class="n">total_subsidy</span> <span class="o">/</span> <span class="n">revenue_per_unit</span> <span class="o">+</span> <span class="n">partial_subsidized_units</span>
                <span class="c1"># right now there are inclusionary requirements</span>
                <span class="n">already_subsidized_units</span> <span class="o">=</span> <span class="n">new_building</span><span class="o">.</span><span class="n">deed_restricted_units</span>

                <span class="c1"># get remainder</span>
                <span class="n">partial_subsidized_units</span> <span class="o">=</span> <span class="n">subsidized_units</span> <span class="o">%</span> <span class="mi">1</span>
                <span class="c1"># round off for now</span>
                <span class="n">subsidized_units</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">subsidized_units</span><span class="p">)</span> <span class="o">+</span> <span class="n">already_subsidized_units</span>
                <span class="c1"># cap at number of residential units</span>
                <span class="n">subsidized_units</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">subsidized_units</span><span class="p">,</span> <span class="n">new_building</span><span class="o">.</span><span class="n">residential_units</span><span class="p">)</span>

                <span class="n">buildings</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;deed_restricted_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">subsidized_units</span><span class="p">))</span>

                <span class="n">buildings</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;subsidized_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">buildings</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;deed_restricted_units&quot;</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">buildings</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;inclusionary_units&quot;</span><span class="p">]</span>

                <span class="c1"># also correct the debug output</span>
                <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;deed_restricted_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">subsidized_units</span><span class="p">))</span>
                <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;subsidized_units&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;deed_restricted_units&quot;</span><span class="p">]</span> <span class="o">-</span> \
                    <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;inclusionary_units&quot;</span><span class="p">]</span>

            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;deed_restricted_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;deed_restricted_units&#39;</span><span class="p">]</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;subsidized_units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_buildings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;subsidized_units&#39;</span><span class="p">]</span>
            <span class="n">account</span><span class="o">.</span><span class="n">add_transaction</span><span class="p">(</span><span class="n">amt</span><span class="p">,</span> <span class="n">subaccount</span><span class="o">=</span><span class="n">subacct</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># turn off this assertion for the Draft Blueprint affordable housing policy since the number of deed restricted units</span>
        <span class="c1"># vs units from development projects looks reasonable</span>
<span class="c1">#        assert np.all(buildings.local.deed_restricted_units.fillna(0) &lt;=</span>
<span class="c1">#                      buildings.local.residential_units.fillna(0))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Amount left after subsidy: $</span><span class="si">{:,.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">total_transactions_by_subacct</span><span class="p">(</span><span class="n">subacct</span><span class="p">)))</span>

        <span class="n">new_buildings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_buildings</span><span class="p">)</span>

    <span class="n">total_len</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">new_buildings_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">total_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No subsidized buildings&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">new_buildings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">new_buildings_list</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Built </span><span class="si">{}</span><span class="s2"> total subsidized buildings&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_buildings</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Total subsidy: $</span><span class="si">{:,.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">new_buildings</span><span class="o">.</span><span class="n">max_profit</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Total subsidized units: </span><span class="si">{:.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_buildings</span><span class="o">.</span><span class="n">residential_units</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>

    <span class="n">new_buildings</span><span class="p">[</span><span class="s2">&quot;subsidized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">new_buildings</span><span class="p">[</span><span class="s2">&quot;policy_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_name</span>

    <span class="n">summary</span><span class="o">.</span><span class="n">add_parcel_output</span><span class="p">(</span><span class="n">new_buildings</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../models-reference/" class="md-footer__link md-footer__link--prev" aria-label="Previous: models" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              models
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "content.code.annotate", "content.tabs.link", "navigation.indexes"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"default": "main", "provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>